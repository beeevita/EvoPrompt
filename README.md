# ğŸ§¬ EvoPrompt
This is the implementation of the paper [Connecting Large Language Models with Evolutionary Algorithms Yields Powerful Prompt Optimizers]()

## ğŸ“ƒ Abstract

Large Language Models (LLMs) excel in various tasks, but they rely on carefully crafted prompts that often demand substantial human effort. To automate this process, in this paper, we propose a novel framework for discrete prompt optimization, called EvoPrompt, which borrows the idea of evolutionary algorithms (EAs) as they exhibit good performance and fast convergence. To enable EAs to work on discrete prompts, which are natural language expressions that need to be coherent and human-readable, we connect LLMs with EAs. This approach allows us to simultaneously leverage the powerful language processing capabilities of LLMs and the efficient optimization performance of EAs. Specifically, abstaining from any gradients or parameters, EvoPrompt starts from a population of prompts and iteratively generates new prompts with LLMs based on the evolutionary operators, improving the population based on the development set. We optimize prompts for both closed- and open-source LLMs including GPT-3.5 and Alpaca, on 31 datasets covering language understanding, generation tasks, as well as BIG-Bench Hard (BBH) tasks. EvoPrompt significantly outperforms human-engineered prompts and existing methods for automatic prompt generation (e.g., up to 25% on BBH). Furthermore, EvoPrompt demonstrates that connecting LLMs with EAs creates synergies, which could inspire further research on the combination of LLMs and conventional algorithms.

## ğŸš€ Quick Start

### âš™ï¸ Preparation

1. **Environmental** settings: `pip install -r requirements.txt`
2. **Data** download: The test data for the language understanding task can be found [here](https://nlp.cs.princeton.edu/projects/lm-bff/datasets.tar). Put the test file in the folder `./data/cls/{dataset_name}`
3. **OpenAI API key** required: add your OpenAI API key and other related settings in the file `auth.yaml`

### â™» Evolution

We instanciate two evolutionary algorithms, GA (genetic algorithm) and DE (diffenrential evolution) to evolve upon the initial population. Evolve your prompts using the following commands: 

Customize the parameter `--llm_type` to use `text-davinci-003`, `gpt-3.5-turbo`,  `gpt-4`, etc. 

```bash
bash scripts/cls/run_ga_alpaca.sh  # Genetic algorithm 
bash scripts/cls/run_de_alpaca.sh  # Differential evolution
```

### Inference

To evaluate a single instruction, run the following:

```bash
bash scripts/cls/eval_single_alpaca.sh  # cls on alpaca
```

### ğŸ“Œ Notes

Note that we have two language models used in our framework, one is for evolution (argument `--llm_type`), the other for the task implementation (`--language_model`). 

#### ğŸ’¡Tips for Usage

The number of iteration and the population size effect the performance of EvoPrompt. There exists a trade-off between the cost and the performance. For relative simple tasks, a size of 10 and 10 iterative steps are enough, or even less. While for complex tasks, a larger population with diversity is required.

#### ğŸ”¢ Arguments

You may need to set the following arguments to customize your own configuration.

* `task`: the task category, such as `sim` (simplification), `cls`(classification), `sum`(summarization). If you need to extend this to other tasks, you may override the metric to evaluate
* `dataset`: the dataset you want to evolve prompt on
* `dev_file`: the path of the devlopment set
* `language model`: the model used for task implementation
* `llm_type`: the LLM used to evolve prompts
* `position`: this argument mainly indicates whether to use demonstration (zero-shot or few-shot)
* `sample_num`: the size of dev set, mainly used for generation task where there is no need to set the `dev_file`
* `prompt_num`: number of examples for few-shot demonstrations

## ğŸ“ Framework

For the pipeline of EvoPrompt, there are mainly three steps as follows, while for each of them algorthms, there exists slight differences to instantiate.

* **Initialization**: We apply prompts generated by GPT and APE as the initial population. (see in the `prompts_pre.txt` and `prompts_pre_ape.txt` under the path of each dataset)
* **Evolution** (mutation and crossover):  For templates used for DE and GA, see the file `./data/templates_ga` and `./data/templates_de`. We use a demonstration including one example of the algorithm implementation to get precise and expected prompt following the steps of evolution. To avoid the LLMs copying the demonstration,the demonstration of the task is different from the task of implementation. 

* **Evaluation and update**: After each iteration, we need select which prompts should be maintained in the population to update.  For GA, we maintain top-$N$ prompts in each iteration while for DE, we replace the old prompt if the newly generated is better. 

### ğŸ§¬ Genetic Algorithm

* **Selection strategy**: in each iteration, we need to select parents for mutation and crossover, as donors to child prompts. Set the argument `sel_mode` to apply different strategy. There are three choices: `["wheel", "random", "tour"]`, we use `wheel` by default.
* **Update**: After generating a population with the same size of the original population, $N$, we select top-$N$ as the new population.

### ğŸ§¬ Differential Evolution

* **Design in DE**: We apply different DE templates for ablations. Specify the argument `template` to use different settings.
  * Eliminate Prompt 3: `--template v2`
  * Prompt 3 (random): add the argument `--donor_random`
  * Prompt 3 (best): `--template v1` (default setting)
  * Different part: `--template v3`
* **Update**: Different from GA, in each iteration for each prompt `p`, several donor prompts are used for the new prompt `p'`, if `p'` is better than `p`, `p` will  be replaced by `p'`. Otherwise, it will be maintained. 

## Code Strucutre 

```
.
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ args.py
â”œâ”€â”€ auth.yaml
â”œâ”€â”€ data  # dataset, templates used
â”‚   â”œâ”€â”€ cls
â”‚   â”œâ”€â”€ sim
â”‚   â”œâ”€â”€ sum
â”‚   â”œâ”€â”€ template_de.py  # templates of prompt evolution by DE
â”‚   â”œâ”€â”€ template_ga.py  # templates of prompt evolution by GA
â”‚   â”œâ”€â”€ template_v2.json  # templates for task implementation
â”‚   â””â”€â”€ templates.py  # wrapper
â”œâ”€â”€ dataset.py  # dataset class
â”œâ”€â”€ evaluator.py  # evaluators on different tasks
â”œâ”€â”€ evoluter.py  # DE, GA, APE
â”œâ”€â”€ evolution.py  # DE, GA, APE
â”œâ”€â”€ get_result.py  
â”œâ”€â”€ infer.py  # main file for inference
â”œâ”€â”€ llm_client.py  # LLM query
â”œâ”€â”€ metrics.py  # metric calculation
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ run.py  # main file for evolution
â”œâ”€â”€ scripts  # scripts to run the code
â””â”€â”€ utils.py  # auxiliary functions
```

## ğŸ§© Possible Extension

* **Aggregation**: Based on the final population of high quality, ensembling strategies can be effectively applied upon the prompts.
* **More fine-grained metrics**: to select prompt maintained in the population, we need to evaluate the performance on dev set. However, for understanding tasks, metrics such as accuracy or F1 are coarse-grained, sometimes it's not accurate anough to select which to keep in the population since the performances of them are the same. 
* **More complex tasks** are left to explore. 

## Acknowledgements

Our codebase is based on the following repos. Thanks for open-sourcing!

- [CoT-hub](https://github.com/FranxYao/chain-of-thought-hub)
- [APE](https://github.com/keirp/automatic_prompt_engineer)
- [LM-BFF](https://github.com/princeton-nlp/LM-BFF)

## â˜‘ï¸ TODO

- [ ] EvoPrompt for BBH tasks

## Code of Conduct

This project has adopted the [Microsoft Open Source Code of Conduct](https://opensource.microsoft.com/codeofconduct/). For more information see the [Code of Conduct FAQ](https://opensource.microsoft.com/codeofconduct/faq/) or contact [opencode@microsoft.com](mailto:opencode@microsoft.com) with any additional questions or comments.

## â˜•ï¸ Citation

If you find this repository helpful, please consider citing our paper:

```
@article{guo2023connecting,
  title={Connecting Large Language Models with Evolutionary Algorithms Yields Powerful Prompt Optimizers},
  author={Guo, Qingyan and Wang, Rui and Guo, Junliang and Li, Bei and Song, Kaitao and Tan, Xu and Liu, Guoqing and Bian, Jiang and Yang, Yujiu},
  journal={arXiv preprint arXiv:2309.08532},
  year={2023}
}
```

